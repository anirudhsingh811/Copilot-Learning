using Azure.Core;
using Azure.Identity;
using Azure.ResourceManager;
using Azure.ResourceManager.ContainerInstance;
using Azure.ResourceManager.ContainerInstance.Models;
using Azure.ResourceManager.Resources;
using Microsoft.Extensions.Logging;

namespace AZ204.ContainerInstances;

/// <summary>
/// Manager for Azure Container Instances - Deployment and Operations
/// </summary>
public class ContainerInstanceManager
{
    private readonly ArmClient _armClient;
    private readonly ILogger<ContainerInstanceManager> _logger;

    public ContainerInstanceManager(ILogger<ContainerInstanceManager> logger, TokenCredential? credential = null)
    {
        _logger = logger;
        _armClient = new ArmClient(credential ?? new DefaultAzureCredential());
    }

    /// <summary>
    /// Creates a simple container instance
    /// </summary>
    public async Task<ContainerGroupResource> CreateSimpleContainerAsync(
        string subscriptionId,
        string resourceGroupName,
        string containerGroupName,
        string imageName,
        string location = "eastus",
        CancellationToken cancellationToken = default)
    {
        _logger.LogInformation("Creating container instance '{ContainerName}'", containerGroupName);

        var subscription = _armClient.GetSubscriptionResource(
            new ResourceIdentifier($"/subscriptions/{subscriptionId}"));
        
        var resourceGroup = await subscription.GetResourceGroupAsync(resourceGroupName, cancellationToken);

        var containerData = new ContainerGroupData(
            new AzureLocation(location),
            new List<ContainerInstanceContainer>
            {
                new ContainerInstanceContainer(
                    "main-container",
                    imageName,
                    new ContainerResourceRequirements(
                        new ContainerResourceRequestsContent(1.0, 1.5)))
                {
                    Ports = { new ContainerPort(80) }
                }
            },
            ContainerInstanceOperatingSystemType.Linux)
        {
            RestartPolicy = ContainerGroupRestartPolicy.Always,
            IPAddress = new ContainerGroupIPAddress(
                new List<ContainerGroupPort> { new ContainerGroupPort(80) },
                ContainerGroupIPAddressType.Public)
        };

        var containerCollection = resourceGroup.Value.GetContainerGroups();
        var result = await containerCollection.CreateOrUpdateAsync(
            Azure.WaitUntil.Completed,
            containerGroupName,
            containerData,
            cancellationToken);

        _logger.LogInformation("Successfully created container instance");
        return result.Value;
    }

    /// <summary>
    /// Creates a multi-container group with sidecar pattern
    /// </summary>
    public async Task<ContainerGroupResource> CreateMultiContainerGroupAsync(
        string subscriptionId,
        string resourceGroupName,
        string containerGroupName,
        string location = "eastus",
        CancellationToken cancellationToken = default)
    {
        _logger.LogInformation("Creating multi-container group '{ContainerName}'", containerGroupName);

        var subscription = _armClient.GetSubscriptionResource(
            new ResourceIdentifier($"/subscriptions/{subscriptionId}"));
        
        var resourceGroup = await subscription.GetResourceGroupAsync(resourceGroupName, cancellationToken);

        // Main application container
        var appContainer = new ContainerInstanceContainer(
            "app-container",
            "mcr.microsoft.com/azuredocs/aci-helloworld",
            new ContainerResourceRequirements(
                new ContainerResourceRequestsContent(1.0, 1.5)))
        {
            Ports = { new ContainerPort(80) }
        };

        // Sidecar logging container
        var loggingContainer = new ContainerInstanceContainer(
            "logging-sidecar",
            "fluent/fluentd",
            new ContainerResourceRequirements(
                new ContainerResourceRequestsContent(0.5, 0.5)));

        var containerData = new ContainerGroupData(
            new AzureLocation(location),
            new List<ContainerInstanceContainer> { appContainer, loggingContainer },
            ContainerInstanceOperatingSystemType.Linux)
        {
            RestartPolicy = ContainerGroupRestartPolicy.Always,
            IPAddress = new ContainerGroupIPAddress(
                new List<ContainerGroupPort> { new ContainerGroupPort(80) },
                ContainerGroupIPAddressType.Public)
        };

        var containerCollection = resourceGroup.Value.GetContainerGroups();
        var result = await containerCollection.CreateOrUpdateAsync(
            Azure.WaitUntil.Completed,
            containerGroupName,
            containerData,
            cancellationToken);

        _logger.LogInformation("Successfully created multi-container group");
        return result.Value;
    }

    /// <summary>
    /// Gets container instance details
    /// </summary>
    public async Task<ContainerGroupResource> GetContainerInstanceAsync(
        string subscriptionId,
        string resourceGroupName,
        string containerGroupName,
        CancellationToken cancellationToken = default)
    {
        var subscription = _armClient.GetSubscriptionResource(
            new ResourceIdentifier($"/subscriptions/{subscriptionId}"));
        
        var resourceGroup = await subscription.GetResourceGroupAsync(resourceGroupName, cancellationToken);
        var container = await resourceGroup.Value.GetContainerGroupAsync(containerGroupName, cancellationToken);

        return container.Value;
    }

    /// <summary>
    /// Lists all container instances in a resource group
    /// </summary>
    public async Task<List<ContainerGroupResource>> ListContainerInstancesAsync(
        string subscriptionId,
        string resourceGroupName,
        CancellationToken cancellationToken = default)
    {
        var subscription = _armClient.GetSubscriptionResource(
            new ResourceIdentifier($"/subscriptions/{subscriptionId}"));
        
        var resourceGroup = await subscription.GetResourceGroupAsync(resourceGroupName, cancellationToken);
        var containers = new List<ContainerGroupResource>();

        await foreach (var container in resourceGroup.Value.GetContainerGroups().GetAllAsync(cancellationToken))
        {
            containers.Add(container);
        }

        return containers;
    }

    /// <summary>
    /// Restarts a container instance
    /// </summary>
    public async Task RestartContainerInstanceAsync(
        string subscriptionId,
        string resourceGroupName,
        string containerGroupName,
        CancellationToken cancellationToken = default)
    {
        _logger.LogInformation("Restarting container instance '{ContainerName}'", containerGroupName);

        var subscription = _armClient.GetSubscriptionResource(
            new ResourceIdentifier($"/subscriptions/{subscriptionId}"));
        
        var resourceGroup = await subscription.GetResourceGroupAsync(resourceGroupName, cancellationToken);
        var container = await resourceGroup.Value.GetContainerGroupAsync(containerGroupName, cancellationToken);

        await container.Value.RestartAsync(Azure.WaitUntil.Completed, cancellationToken);
        _logger.LogInformation("Successfully restarted container instance");
    }

    /// <summary>
    /// Deletes a container instance
    /// </summary>
    public async Task DeleteContainerInstanceAsync(
        string subscriptionId,
        string resourceGroupName,
        string containerGroupName,
        CancellationToken cancellationToken = default)
    {
        _logger.LogInformation("Deleting container instance '{ContainerName}'", containerGroupName);

        var subscription = _armClient.GetSubscriptionResource(
            new ResourceIdentifier($"/subscriptions/{subscriptionId}"));
        
        var resourceGroup = await subscription.GetResourceGroupAsync(resourceGroupName, cancellationToken);
        var container = await resourceGroup.Value.GetContainerGroupAsync(containerGroupName, cancellationToken);

        await container.Value.DeleteAsync(Azure.WaitUntil.Completed, cancellationToken);
        _logger.LogInformation("Successfully deleted container instance");
    }

    /// <summary>
    /// Gets container logs
    /// </summary>
    public async Task<string> GetContainerLogsAsync(
        string subscriptionId,
        string resourceGroupName,
        string containerGroupName,
        string containerName,
        int? tail = 100,
        CancellationToken cancellationToken = default)
    {
        var subscription = _armClient.GetSubscriptionResource(
            new ResourceIdentifier($"/subscriptions/{subscriptionId}"));
        
        var resourceGroup = await subscription.GetResourceGroupAsync(resourceGroupName, cancellationToken);
        var containerGroup = await resourceGroup.Value.GetContainerGroupAsync(containerGroupName, cancellationToken);

        var logs = await containerGroup.Value.GetLogsAsync(containerName, tail, cancellationToken: cancellationToken);
        return logs.Value.Content ?? "No logs available";
    }
}
