# Real Azure Functions - Production Ready

This project contains **actual Azure Functions** with real triggers and bindings that can be deployed to Azure.

## ?? What's Different from the Simulations?

### Console App (Simulated)
- ? Fake triggers - just console demos
- ? No actual Azure integration
- ? Can't deploy to Azure
- ? No automatic scaling

### Real Azure Functions (This Project)
- ? Real HTTP, Timer, Queue, and Blob triggers
- ? Actual Azure bindings
- ? Deploy to Azure Function App
- ? Automatic scaling and serverless
- ? Azure portal monitoring
- ? Application Insights integration

## ?? Project Structure

```
AZ204-RealFunctions/
??? HttpTriggerFunctions.cs      # HTTP GET, POST with route params
??? TimerTriggerFunctions.cs     # Scheduled tasks with CRON
??? QueueTriggerFunctions.cs     # Queue message processing
??? BlobTriggerFunctions.cs      # File processing triggers
??? Program.cs                   # Function host configuration
??? host.json                    # Function app settings
??? local.settings.json          # Local development settings
```

## ??? Prerequisites

1. **Azure Functions Core Tools**
   ```bash
   npm install -g azure-functions-core-tools@4 --unsafe-perm true
   ```

2. **Azurite (Storage Emulator)**
   ```bash
   npm install -g azurite
   ```

3. **.NET 8 SDK** (already installed)

4. **Visual Studio Code** with Azure Functions extension (optional)

## ?? Running Locally

### Step 1: Start Azurite (Storage Emulator)
```bash
# In a new terminal
azurite --silent --location c:\azurite --debug c:\azurite\debug.log
```

### Step 2: Create Storage Resources (Queues & Containers)

**IMPORTANT:** Before running functions, you must create the required queues and blob containers!

#### Option 1: Use the Setup Script (Recommended)
```powershell
cd AZ204-RealFunctions
.\Setup-LocalStorage.ps1
```

This creates:
- **Queues**: `order-queue`, `notifications-queue`, `batch-orders-queue`
- **Containers**: `uploads`, `data-imports`, `documents`

#### Option 2: Manual Setup
```powershell
# Install Azure Storage module
Install-Module -Name Az.Storage -Force -Scope CurrentUser

# Create storage context
$ctx = New-AzStorageContext -ConnectionString "UseDevelopmentStorage=true"

# Create queues
New-AzStorageQueue -Name "order-queue" -Context $ctx
New-AzStorageQueue -Name "notifications-queue" -Context $ctx
New-AzStorageQueue -Name "batch-orders-queue" -Context $ctx

# Create blob containers
New-AzStorageContainer -Name "uploads" -Context $ctx
New-AzStorageContainer -Name "data-imports" -Context $ctx
New-AzStorageContainer -Name "documents" -Context $ctx
```

### Step 3: Run the Functions
```bash
cd AZ204-RealFunctions
func start
```

### Step 4: Test the Functions

#### HTTP Trigger - GET
```bash
# Browser or Postman
http://localhost:7071/api/hello?name=YourName

# PowerShell
Invoke-RestMethod -Uri "http://localhost:7071/api/hello?name=Azure" -Method Get
```

#### HTTP Trigger - POST (Create Order)
```powershell
$body = @{
    ProductName = "Premium Widget"
    Quantity = 5
    UnitPrice = 29.99
    CustomerEmail = "test@example.com"
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://localhost:7071/api/orders" -Method Post -Body $body -ContentType "application/json"
```

#### HTTP Trigger - GET Order Status
```bash
http://localhost:7071/api/orders/12345
```

#### Trigger Timer Functions Manually
```powershell
# Daily Cleanup
Invoke-RestMethod -Uri "http://localhost:7071/admin/functions/DailyCleanupJob" -Method Post

# Health Check
Invoke-RestMethod -Uri "http://localhost:7071/admin/functions/HourlyHealthCheck" -Method Post
```

#### Add Message to Queue (Triggers Queue Function)
```powershell
# Install Azure Storage Tools
Install-Module -Name Az.Storage -Force -Scope CurrentUser

# Add message to queue
$ctx = New-AzStorageContext -ConnectionString "UseDevelopmentStorage=true"
$queueMessage = @{
    OrderId = "ORD-12345"
    ProductName = "Test Product"
    Quantity = 3
    UnitPrice = 19.99
    TotalAmount = 59.97
    CustomerEmail = "test@example.com"
    OrderDate = (Get-Date).ToString("o")
    Status = "Pending"
} | ConvertTo-Json

$queue = Get-AzStorageQueue -Name "order-queue" -Context $ctx
$queue.CloudQueue.AddMessageAsync($queueMessage)
```

## ?? Function Triggers Explained

### 1. HTTP Triggers
```csharp
[Function("HttpGetExample")]
public async Task<HttpResponseData> HttpGet(
    [HttpTrigger(AuthorizationLevel.Function, "get", Route = "hello")] HttpRequestData req)
```
- **Authorization Levels**: Anonymous, Function, Admin
- **Methods**: GET, POST, PUT, DELETE, PATCH
- **Routes**: Custom routing like `api/orders/{orderId}`

### 2. Timer Triggers
```csharp
[Function("DailyCleanupJob")]
public async Task DailyCleanup(
    [TimerTrigger("0 0 2 * * *")] TimerInfo timerInfo)
```
- **CRON Format**: `{second} {minute} {hour} {day} {month} {day-of-week}`
- **Examples**:
  - `0 0 2 * * *` - Daily at 2 AM
  - `0 0 * * * *` - Every hour
  - `0 */5 * * * *` - Every 5 minutes
  - `0 0 9 * * 1-5` - Weekdays at 9 AM

### 3. Queue Triggers
```csharp
[Function("ProcessOrderFromQueue")]
public async Task ProcessOrder(
    [QueueTrigger("order-queue", Connection = "AzureWebJobsStorage")] string orderMessage)
```
- Automatically scales based on queue length
- Poison queue handling (after 5 failed attempts)
- Batch processing support

### 4. Blob Triggers
```csharp
[Function("ImageThumbnailGenerator")]
public async Task GenerateThumbnail(
    [BlobTrigger("uploads/{name}", Connection = "StorageConnection")] byte[] imageBlob,
    string name)
```
- Triggered when files are uploaded
- Path patterns: `container/{name}`, `container/{folder}/{name}.{ext}`

## ?? Deploying to Azure

### Option 1: VS Code Extension
1. Install Azure Functions extension
2. Right-click project ? "Deploy to Function App"
3. Select or create Function App
4. Deploy!

### Option 2: Azure CLI
```bash
# Login
az login

# Create Resource Group
az group create --name rg-functions-demo --location eastus

# Create Storage Account
az storage account create \
  --name stfuncdemo$(Get-Random) \
  --resource-group rg-functions-demo \
  --location eastus \
  --sku Standard_LRS

# Create Function App
az functionapp create \
  --resource-group rg-functions-demo \
  --consumption-plan-location eastus \
  --runtime dotnet-isolated \
  --runtime-version 8 \
  --functions-version 4 \
  --name func-az204-demo-$(Get-Random) \
  --storage-account stfuncdemo

# Deploy
func azure functionapp publish func-az204-demo-xxxxx
```

### Option 3: GitHub Actions (CI/CD)
See `.github/workflows/deploy-functions.yml` for automated deployments.

## ?? Configuration

### local.settings.json (Local)
```json
{
  "Values": {
    "AzureWebJobsStorage": "UseDevelopmentStorage=true",
    "FUNCTIONS_WORKER_RUNTIME": "dotnet-isolated",
    "DatabaseConnectionString": "Server=localhost;...",
    "ServiceBusConnection": "",
    "StorageConnection": "UseDevelopmentStorage=true"
  }
}
```

### Application Settings (Azure)
In Azure Portal ? Function App ? Configuration ? Application Settings:
- `AzureWebJobsStorage` - Your storage account connection string
- `APPINSIGHTS_INSTRUMENTATIONKEY` - Application Insights key
- `DatabaseConnectionString` - Your database connection
- `ServiceBusConnection` - Service Bus connection string

## ?? Monitoring

### Application Insights
All functions automatically send telemetry to Application Insights:
- Request duration and count
- Dependencies (database, external APIs)
- Exceptions and failures
- Custom metrics and events

### Azure Portal
- **Live Metrics**: Real-time function execution
- **Function Monitor**: Execution history and logs
- **Log Stream**: Live log streaming

### Log Queries (KQL)
```kusto
// Failed function executions
traces
| where severityLevel >= 3
| where message contains "Failed"
| order by timestamp desc

// Function performance
requests
| where name startswith "Function"
| summarize avg(duration), count() by name
| order by avg_duration desc
```

## ?? Cost Considerations

### Consumption Plan (Serverless)
- **First 1 million executions**: FREE
- **After that**: $0.20 per million executions
- **Execution time**: $0.000016/GB-s
- **Best for**: Variable load, low traffic

### Premium Plan
- **Always warm** (no cold start)
- **VNet integration**
- **Starts at**: ~$160/month
- **Best for**: Production apps with SLA requirements

### App Service Plan
- **Dedicated resources**
- **Predictable billing**
- **Same cost as App Service**
- **Best for**: Always-on workloads

## ?? Testing Individual Functions

### Test Timer Function Immediately
```bash
# Don't wait for schedule - trigger now
curl -X POST http://localhost:7071/admin/functions/DailyCleanupJob
```

### Test Queue Function
```bash
# Add message via Storage Explorer or Azure CLI
az storage message put \
  --queue-name order-queue \
  --content '{"OrderId":"123","ProductName":"Test"}' \
  --connection-string "UseDevelopmentStorage=true"
```

### Test Blob Function
```bash
# Upload file to trigger function
az storage blob upload \
  --container-name uploads \
  --file myimage.jpg \
  --name myimage.jpg \
  --connection-string "UseDevelopmentStorage=true"
```

## ?? Security Best Practices

1. **Use Managed Identity** in Azure (no connection strings needed)
2. **Store secrets in Key Vault**, reference in app settings
3. **Use Function-level auth** (`AuthorizationLevel.Function`)
4. **Enable HTTPS only** in production
5. **Implement API key rotation**
6. **Use Azure AD authentication** for HTTP triggers

## ?? Learn More

- [Azure Functions Documentation](https://docs.microsoft.com/azure/azure-functions/)
- [Triggers and Bindings](https://docs.microsoft.com/azure/azure-functions/functions-triggers-bindings)
- [Durable Functions](https://docs.microsoft.com/azure/azure-functions/durable/durable-functions-overview)
- [Best Practices](https://docs.microsoft.com/azure/azure-functions/functions-best-practices)

## ?? AZ-204 Exam Tips

**Know these cold:**
- All trigger types and their properties
- Authorization levels (Anonymous, Function, Admin)
- CRON expression format
- Poison queue handling
- Hosting plans comparison
- Cold start mitigation (Premium plan)
- Scaling behavior for each plan
- Binding direction (in, out, inout)

## ?? Troubleshooting

### "No job functions found"
- Check `[Function]` attribute is present
- Ensure SDK packages are installed
- Run `dotnet clean && dotnet build`

### "Storage emulator not running"
- Start Azurite: `azurite --silent`
- Check `AzureWebJobsStorage` connection string

### "Port 7071 already in use"
- Stop other function apps
- Or change port in `local.settings.json`: `"Host": { "LocalHttpPort": 7072 }`

### Functions not triggering
- Check function logs for errors
- Verify connection strings
- Ensure queue/blob containers exist
- Check timer CRON expression

---

## ? Quick Start Checklist

- [ ] Install Azure Functions Core Tools
- [ ] Install Azurite
- [ ] Start Azurite (`azurite --silent`)
- [ ] Run functions (`func start`)
- [ ] Test HTTP endpoint in browser
- [ ] Create order via POST request
- [ ] Watch queue function process order
- [ ] Deploy to Azure
- [ ] Monitor in Application Insights

**Now you have REAL Azure Functions that work in production! ??**
