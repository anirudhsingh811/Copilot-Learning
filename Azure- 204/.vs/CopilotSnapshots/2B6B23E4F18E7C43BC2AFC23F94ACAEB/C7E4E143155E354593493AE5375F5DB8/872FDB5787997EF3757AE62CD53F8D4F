using Microsoft.Azure.Functions.Worker;
using Microsoft.Azure.Functions.Worker.Http;
using Microsoft.Extensions.Logging;
using System.Net;
using System.Text.Json;

namespace AZ204.RealFunctions;

/// <summary>
/// Real HTTP Triggered Azure Functions
/// These are actual functions that can be deployed to Azure
/// </summary>
public class HttpTriggerFunctions
{
    private readonly ILogger<HttpTriggerFunctions> _logger;

    public HttpTriggerFunctions(ILogger<HttpTriggerFunctions> logger)
    {
        _logger = logger;
    }

    /// <summary>
    /// Simple HTTP GET function
    /// Endpoint: GET http://localhost:7071/api/hello?name=YourName
    /// </summary>
    [Function("HttpGetExample")]
    public async Task<HttpResponseData> HttpGet(
        [HttpTrigger(AuthorizationLevel.Function, "get", Route = "hello")] HttpRequestData req)
    {
        _logger.LogInformation("HTTP GET request received");

        var query = System.Web.HttpUtility.ParseQueryString(req.Url.Query);
        var name = query["name"] ?? "World";

        var response = req.CreateResponse(HttpStatusCode.OK);
        response.Headers.Add("Content-Type", "application/json");

        var result = new
        {
            Message = $"Hello, {name}!",
            Timestamp = DateTime.UtcNow,
            Method = "GET"
        };

        await response.WriteAsJsonAsync(result);
        return response;
    }

    /// <summary>
    /// HTTP POST function for order processing
    /// Endpoint: POST http://localhost:7071/api/orders
    /// Body: { "ProductName": "Widget", "Quantity": 5, "UnitPrice": 29.99, "CustomerEmail": "test@example.com" }
    /// </summary>
    [Function("ProcessOrder")]
    [QueueOutput("order-queue", Connection = "AzureWebJobsStorage")]
    public async Task<OrderProcessResponse> ProcessOrder(
        [HttpTrigger(AuthorizationLevel.Function, "post", Route = "orders")] HttpRequestData req)
    {
        _logger.LogInformation("Processing order request");

        // Read request body
        var requestBody = await new StreamReader(req.Body).ReadToEndAsync();
        var order = JsonSerializer.Deserialize<OrderRequest>(requestBody);

        if (order == null || string.IsNullOrEmpty(order.ProductName))
        {
            throw new ArgumentException("Invalid order data");
        }

        // Generate order ID
        var orderId = Guid.NewGuid().ToString();
        var totalAmount = order.Quantity * order.UnitPrice;

        // Create order message
        var orderMessage = new
        {
            OrderId = orderId,
            ProductName = order.ProductName,
            Quantity = order.Quantity,
            UnitPrice = order.UnitPrice,
            TotalAmount = totalAmount,
            CustomerEmail = order.CustomerEmail,
            OrderDate = DateTime.UtcNow,
            Status = "Pending"
        };

        _logger.LogInformation($"Order {orderId} queued for processing");

        // Return both HTTP response and queue message
        return new OrderProcessResponse
        {
            HttpResponse = new OrderResponse
            {
                OrderId = orderId,
                Message = "Order received and queued for processing",
                TotalAmount = totalAmount,
                EstimatedProcessingTime = "2-5 minutes"
            },
            QueueMessage = JsonSerializer.Serialize(orderMessage)
        };
    }

    /// <summary>
    /// HTTP GET function with route parameters
    /// Endpoint: GET http://localhost:7071/api/orders/{orderId}
    /// </summary>
    [Function("GetOrderStatus")]
    public async Task<HttpResponseData> GetOrderStatus(
        [HttpTrigger(AuthorizationLevel.Function, "get", Route = "orders/{orderId}")] HttpRequestData req,
        string orderId)
    {
        _logger.LogInformation($"Getting status for order {orderId}");

        // In a real app, you'd query a database
        var response = req.CreateResponse(HttpStatusCode.OK);
        await response.WriteAsJsonAsync(new
        {
            OrderId = orderId,
            Status = "Processing",
            EstimatedCompletion = DateTime.UtcNow.AddMinutes(3),
            LastUpdated = DateTime.UtcNow
        });

        return response;
    }
}

public record OrderRequest(
    string ProductName,
    int Quantity,
    decimal UnitPrice,
    string CustomerEmail
);
